{"version":3,"file":"queue-manager.js","mappings":"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","sources":["webpack:///./queue-manager.js"],"sourcesContent":["/**\n * @link https://craftcms.com/\n * @copyright Copyright (c) Pixel & Tonic, Inc.\n * @license https://craftcms.github.io/license/\n */\n\n/**\n * Vue component for the Queue manager\n *\n * @author Pixel & Tonic, Inc. <support@pixelandtonic.com>\n * @author Global Network Group | Giel Tettelaar <giel@yellowflash.net>\n * @since 3.2.0\n */\nnew Vue({\n  el: '#main',\n  delimiters: ['[[', ']]'],\n  data() {\n    return {\n      loading: false,\n      indexTimeout: null,\n      jobs: [],\n      totalJobs: null,\n      totalJobsFormatted: null,\n      activeJobId: null,\n      activeJob: null,\n      limit: 50,\n    };\n  },\n\n  /**\n   * Mounted function\n   */\n  mounted() {\n    document.getElementById('queue-manager-utility').removeAttribute('class');\n\n    Craft.cp.on('setJobInfo', () => {\n      this.jobs = Craft.cp.jobInfo.slice(0);\n      this.totalJobs = Craft.cp.totalJobs;\n      this.totalJobsFormatted = Craft.formatNumber(this.totalJobs);\n      if (!this.loading) {\n        this.refreshActiveJob();\n      }\n    });\n\n    window.onpopstate = (event) => {\n      if (event.state && event.state.jobId) {\n        this.setActiveJob(event.state.jobId, false);\n      } else {\n        this.clearActiveJob(false);\n      }\n    };\n\n    // Was a specific job requested?\n    let m = Craft.path.match(/utilities\\/queue-manager\\/([^\\/]+)/);\n    if (m) {\n      let jobId = m[1];\n      history.replaceState({jobId}, '', this.url(jobId));\n      this.setActiveJob(jobId, false);\n    }\n  },\n\n  methods: {\n    /**\n     * Force-updates the job progress.\n     */\n    updateJobProgress() {\n      Craft.cp.trackJobProgress(false, true);\n    },\n\n    /**\n     * Sets the active job that should be shown.\n     * @param {string} jobId\n     * @param {boolean} pushState\n     * @return {Promise}\n     */\n    setActiveJob(jobId, pushState) {\n      return new Promise((resolve, reject) => {\n        window.clearTimeout(this.indexTimeout);\n        this.loading = true;\n        this.activeJobId = jobId;\n\n        if (pushState) {\n          history.pushState({jobId}, '', this.url(jobId));\n        }\n\n        axios\n          .get(Craft.getActionUrl('queue/get-job-details?id=' + jobId + '', {}))\n          .then(\n            (response) => {\n              if (response.data.id != this.activeJobId) {\n                resolve(false);\n                return;\n              }\n              this.activeJob = response.data;\n              this.loading = false;\n              resolve(true);\n            },\n            (response) => {\n              Craft.cp.displayError(response.response.data.error);\n              reject(response);\n            }\n          );\n      });\n    },\n\n    /**\n     * Refreshes the active job\n     * @return {Promise}\n     */\n    refreshActiveJob() {\n      return new Promise((resolve, reject) => {\n        if (!this.activeJobId) {\n          resolve(false);\n          return;\n        }\n        let oldJob = this.activeJob;\n        this.setActiveJob(this.activeJobId, false)\n          .then((success) => {\n            // If it's done now, the response is probably missing critical info about the job\n            if (success && oldJob && this.activeJob.status == 3) {\n              $.extend(oldJob, {\n                progress: 100,\n                status: 3,\n              });\n              delete oldJob.error;\n              delete oldJob.progressLabel;\n              this.activeJob = oldJob;\n            }\n            resolve(success);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries all jobs.\n     * @return {Promise}\n     */\n    retryAll() {\n      return new Promise((resolve, reject) => {\n        window.clearTimeout(this.indexTimeout);\n        Craft.sendActionRequest('POST', 'queue/retry-all')\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'Retrying all failed jobs.'));\n            this.updateJobProgress();\n            resolve();\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Releases all jobs.\n     * @return {Promise}\n     */\n    releaseAll() {\n      return new Promise((resolve, reject) => {\n        if (\n          !confirm(\n            Craft.t(\n              'app',\n              'Are you sure you want to release all jobs in the queue?'\n            )\n          )\n        ) {\n          resolve(false);\n          return;\n        }\n\n        Craft.sendActionRequest('POST', 'queue/release-all')\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'All jobs released.'));\n            this.clearActiveJob(true);\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries a specific job.\n     * @param {Object} job\n     * @return {Promise}\n     */\n    retryJob(job) {\n      return new Promise((resolve, reject) => {\n        // Only confirm if the job is currently reserved\n        if (job.status == 2) {\n          let message = Craft.t(\n            'app',\n            'Are you sure you want to restart the job “{description}”? Any progress could be lost.',\n            {\n              description: job.description,\n            }\n          );\n          if (!confirm(message)) {\n            resolve(false);\n            return;\n          }\n        }\n\n        window.clearTimeout(this.indexTimeout);\n\n        Craft.sendActionRequest('POST', 'queue/retry', {data: {id: job.id}})\n          .then((response) => {\n            if (job.status == 2) {\n              Craft.cp.displayNotice(Craft.t('app', 'Job restarted.'));\n            } else {\n              Craft.cp.displayNotice(Craft.t('app', 'Job retried.'));\n            }\n\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries the active job.\n     * @return {Promise}\n     */\n    retryActiveJob() {\n      return new Promise((resolve, reject) => {\n        this.retryJob(this.activeJob).then(resolve).catch(reject);\n      });\n    },\n\n    /**\n     * Releases a job.\n     * @param {Object} job\n     * @returns {Promise}\n     */\n    releaseJob(job) {\n      return new Promise((resolve, reject) => {\n        let message = Craft.t(\n          'app',\n          'Are you sure you want to release the job “{description}”?',\n          {\n            description: job.description,\n          }\n        );\n        if (!confirm(message)) {\n          resolve(false);\n          return;\n        }\n\n        Craft.sendActionRequest('POST', 'queue/release', {data: {id: job.id}})\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'Job released.'));\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(({response}) => reject);\n      });\n    },\n\n    /**\n     * Releases the active job.\n     * @returns {Promise}\n     */\n    releaseActiveJob() {\n      return new Promise((resolve, reject) => {\n        this.releaseJob(this.activeJob)\n          .then((released) => {\n            if (released) {\n              this.clearActiveJob(true);\n            }\n            resolve(released);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Resets an active job so that the index screen is displayed.\n     * @param {boolean} pushState\n     */\n    clearActiveJob(pushState) {\n      if (!this.activeJob) {\n        return;\n      }\n\n      this.activeJob = null;\n      this.activeJobId = null;\n\n      if (pushState) {\n        history.pushState({}, '', this.url());\n      }\n    },\n\n    /**\n     * Returns a Queue Manager URL.\n     * @param {string|null} jobId\n     * @returns {string}\n     */\n    url(jobId) {\n      return Craft.getUrl(\n        'utilities/queue-manager' + (jobId ? '/' + jobId : '')\n      );\n    },\n\n    /**\n     * Returns whether a job can be retried.\n     * @param {Object} job\n     * @returns {boolean}\n     */\n    isRetryable(job) {\n      return job.status == 2 || job.status == 4;\n    },\n\n    /**\n     * Returns the class name a job's status cell should have.\n     * @param {number} status\n     * @returns {string}\n     */\n    jobStatusClass(status) {\n      if (status == 4) {\n        return 'error';\n      }\n      return '';\n    },\n\n    /**\n     * Returns a job status code.\n     * @param {number} status\n     * @param {number} delay\n     * @returns {string}\n     */\n    jobStatusLabel(status, delay) {\n      if (delay) {\n        return Craft.t('app', 'Delayed');\n      }\n\n      switch (status) {\n        case 1:\n          return Craft.t('app', 'Pending');\n          break;\n        case 2:\n          return Craft.t('app', 'Reserved');\n          break;\n        case 3:\n          return Craft.t('app', 'Finished');\n          break;\n        case 4:\n          return Craft.t('app', 'Failed');\n          break;\n        default:\n          return '';\n      }\n    },\n\n    /**\n     * Returns a job status icon class.\n     * @param {number} status\n     * @returns {string}\n     */\n    jobStatusIconClass(status) {\n      let c = 'status';\n      switch (status) {\n        case 1:\n          c += ' orange';\n          break;\n        case 2:\n          c += ' green';\n          break;\n        case 4:\n          c += ' red';\n          break;\n      }\n      return c;\n    },\n\n    /**\n     * Returns a job attribute name.\n     * @param {string} name\n     * @returns {string}\n     */\n    jobAttributeName(name) {\n      switch (name) {\n        case 'id':\n          return Craft.t('app', 'ID');\n        case 'status':\n          return Craft.t('app', 'Status');\n        case 'progress':\n          return Craft.t('app', 'Progress');\n        case 'description':\n          return Craft.t('app', 'Description');\n        case 'ttr':\n          return Craft.t('app', 'Time to reserve');\n        case 'error':\n          return Craft.t('app', 'Error');\n        default:\n          return name;\n      }\n    },\n\n    /**\n     * Formats a TTR value.\n     * @param {string} value\n     * @return {string}\n     */\n    ttrValue(value) {\n      return Craft.t(\n        'app',\n        '{num, number} {num, plural, =1{second} other{seconds}}',\n        {\n          num: value,\n        }\n      );\n    },\n  },\n});\n"],"names":["Vue","el","delimiters","data","loading","indexTimeout","jobs","totalJobs","totalJobsFormatted","activeJobId","activeJob","limit","mounted","_this","document","getElementById","removeAttribute","Craft","cp","on","jobInfo","slice","formatNumber","refreshActiveJob","window","onpopstate","event","state","jobId","setActiveJob","clearActiveJob","m","path","match","history","replaceState","this","url","methods","updateJobProgress","trackJobProgress","pushState","_this2","Promise","resolve","reject","clearTimeout","axios","get","getActionUrl","then","response","id","displayError","error","_this3","oldJob","success","status","$","extend","progress","progressLabel","catch","retryAll","_this4","sendActionRequest","displayNotice","t","releaseAll","_this5","confirm","retryJob","job","_this6","message","description","retryActiveJob","_this7","releaseJob","_this8","_ref","releaseActiveJob","_this9","released","getUrl","isRetryable","jobStatusClass","jobStatusLabel","delay","jobStatusIconClass","c","jobAttributeName","name","ttrValue","value","num"],"sourceRoot":""}