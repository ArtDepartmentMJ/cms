{"version":3,"file":"queue-manager.js","mappings":"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","sources":["webpack:///./queue-manager.js"],"sourcesContent":["/**\n * @link https://craftcms.com/\n * @copyright Copyright (c) Pixel & Tonic, Inc.\n * @license https://craftcms.github.io/license/\n */\n\n/**\n * Vue component for the Queue manager\n *\n * @author Pixel & Tonic, Inc. <support@pixelandtonic.com>\n * @author Global Network Group | Giel Tettelaar <giel@yellowflash.net>\n * @since 3.2.0\n */\nnew Vue({\n  el: '#main',\n  delimiters: ['[[', ']]'],\n  data() {\n    return {\n      loading: false,\n      indexTimeout: null,\n      jobs: [],\n      totalJobs: null,\n      totalJobsFormatted: null,\n      activeJobId: null,\n      activeJob: null,\n      limit: 50,\n    };\n  },\n\n  /**\n   * Mounted function\n   */\n  mounted() {\n    document.getElementById('queue-manager-utility').removeAttribute('class');\n\n    Craft.cp.on('setJobInfo', () => {\n      this.jobs = Craft.cp.jobInfo.slice(0);\n      this.totalJobs = Craft.cp.totalJobs;\n      this.totalJobsFormatted = Craft.formatNumber(this.totalJobs);\n      if (!this.loading) {\n        this.refreshActiveJob();\n      }\n    });\n\n    window.onpopstate = (event) => {\n      if (event.state && event.state.jobId) {\n        this.setActiveJob(event.state.jobId, false);\n      } else {\n        this.clearActiveJob(false);\n      }\n    };\n\n    // Was a specific job requested?\n    let m = Craft.path.match(/utilities\\/queue-manager\\/([^\\/]+)/);\n    if (m) {\n      let jobId = m[1];\n      history.replaceState({jobId}, '', this.url(jobId));\n      this.setActiveJob(jobId, false);\n    }\n  },\n\n  methods: {\n    /**\n     * Force-updates the job progress.\n     */\n    updateJobProgress() {\n      Craft.cp.trackJobProgress(false, true);\n    },\n\n    /**\n     * Sets the active job that should be shown.\n     * @param {string} jobId\n     * @param {boolean} pushState\n     * @return {Promise}\n     */\n    setActiveJob(jobId, pushState) {\n      return new Promise((resolve, reject) => {\n        window.clearTimeout(this.indexTimeout);\n        this.loading = true;\n        this.activeJobId = jobId;\n\n        if (pushState) {\n          history.pushState({jobId}, '', this.url(jobId));\n        }\n\n        axios\n          .get(Craft.getActionUrl('queue/get-job-details?id=' + jobId + '', {}))\n          .then(\n            (response) => {\n              if (response.data.id != this.activeJobId) {\n                resolve(false);\n                return;\n              }\n              this.activeJob = response.data;\n              this.loading = false;\n              resolve(true);\n            },\n            (e) => {\n              Craft.cp.displayError(e?.response?.data?.message);\n              reject(e);\n            }\n          );\n      });\n    },\n\n    /**\n     * Refreshes the active job\n     * @return {Promise}\n     */\n    refreshActiveJob() {\n      return new Promise((resolve, reject) => {\n        if (!this.activeJobId) {\n          resolve(false);\n          return;\n        }\n        let oldJob = this.activeJob;\n        this.setActiveJob(this.activeJobId, false)\n          .then((success) => {\n            // If it's done now, the response is probably missing critical info about the job\n            if (success && oldJob && this.activeJob.status == 3) {\n              $.extend(oldJob, {\n                progress: 100,\n                status: 3,\n              });\n              delete oldJob.error;\n              delete oldJob.progressLabel;\n              this.activeJob = oldJob;\n            }\n            resolve(success);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries all jobs.\n     * @return {Promise}\n     */\n    retryAll() {\n      return new Promise((resolve, reject) => {\n        window.clearTimeout(this.indexTimeout);\n        Craft.sendActionRequest('POST', 'queue/retry-all')\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'Retrying all failed jobs.'));\n            this.updateJobProgress();\n            resolve();\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Releases all jobs.\n     * @return {Promise}\n     */\n    releaseAll() {\n      return new Promise((resolve, reject) => {\n        if (\n          !confirm(\n            Craft.t(\n              'app',\n              'Are you sure you want to release all jobs in the queue?'\n            )\n          )\n        ) {\n          resolve(false);\n          return;\n        }\n\n        Craft.sendActionRequest('POST', 'queue/release-all')\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'All jobs released.'));\n            this.clearActiveJob(true);\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries a specific job.\n     * @param {Object} job\n     * @return {Promise}\n     */\n    retryJob(job) {\n      return new Promise((resolve, reject) => {\n        // Only confirm if the job is currently reserved\n        if (job.status == 2) {\n          let message = Craft.t(\n            'app',\n            'Are you sure you want to restart the job “{description}”? Any progress could be lost.',\n            {\n              description: job.description,\n            }\n          );\n          if (!confirm(message)) {\n            resolve(false);\n            return;\n          }\n        }\n\n        window.clearTimeout(this.indexTimeout);\n\n        Craft.sendActionRequest('POST', 'queue/retry', {data: {id: job.id}})\n          .then((response) => {\n            if (job.status == 2) {\n              Craft.cp.displayNotice(Craft.t('app', 'Job restarted.'));\n            } else {\n              Craft.cp.displayNotice(Craft.t('app', 'Job retried.'));\n            }\n\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Retries the active job.\n     * @return {Promise}\n     */\n    retryActiveJob() {\n      return new Promise((resolve, reject) => {\n        this.retryJob(this.activeJob).then(resolve).catch(reject);\n      });\n    },\n\n    /**\n     * Releases a job.\n     * @param {Object} job\n     * @returns {Promise}\n     */\n    releaseJob(job) {\n      return new Promise((resolve, reject) => {\n        let message = Craft.t(\n          'app',\n          'Are you sure you want to release the job “{description}”?',\n          {\n            description: job.description,\n          }\n        );\n        if (!confirm(message)) {\n          resolve(false);\n          return;\n        }\n\n        Craft.sendActionRequest('POST', 'queue/release', {data: {id: job.id}})\n          .then((response) => {\n            Craft.cp.displayNotice(Craft.t('app', 'Job released.'));\n            this.updateJobProgress();\n            resolve(true);\n          })\n          .catch(({response}) => reject);\n      });\n    },\n\n    /**\n     * Releases the active job.\n     * @returns {Promise}\n     */\n    releaseActiveJob() {\n      return new Promise((resolve, reject) => {\n        this.releaseJob(this.activeJob)\n          .then((released) => {\n            if (released) {\n              this.clearActiveJob(true);\n            }\n            resolve(released);\n          })\n          .catch(reject);\n      });\n    },\n\n    /**\n     * Resets an active job so that the index screen is displayed.\n     * @param {boolean} pushState\n     */\n    clearActiveJob(pushState) {\n      if (!this.activeJob) {\n        return;\n      }\n\n      this.activeJob = null;\n      this.activeJobId = null;\n\n      if (pushState) {\n        history.pushState({}, '', this.url());\n      }\n    },\n\n    /**\n     * Returns a Queue Manager URL.\n     * @param {string|null} jobId\n     * @returns {string}\n     */\n    url(jobId) {\n      return Craft.getUrl(\n        'utilities/queue-manager' + (jobId ? '/' + jobId : '')\n      );\n    },\n\n    /**\n     * Returns whether a job can be retried.\n     * @param {Object} job\n     * @returns {boolean}\n     */\n    isRetryable(job) {\n      return job.status == 2 || job.status == 4;\n    },\n\n    /**\n     * Returns the class name a job's status cell should have.\n     * @param {number} status\n     * @returns {string}\n     */\n    jobStatusClass(status) {\n      if (status == 4) {\n        return 'error';\n      }\n      return '';\n    },\n\n    /**\n     * Returns a job status code.\n     * @param {number} status\n     * @param {number} delay\n     * @returns {string}\n     */\n    jobStatusLabel(status, delay) {\n      if (delay) {\n        return Craft.t('app', 'Delayed');\n      }\n\n      switch (status) {\n        case 1:\n          return Craft.t('app', 'Pending');\n          break;\n        case 2:\n          return Craft.t('app', 'Reserved');\n          break;\n        case 3:\n          return Craft.t('app', 'Finished');\n          break;\n        case 4:\n          return Craft.t('app', 'Failed');\n          break;\n        default:\n          return '';\n      }\n    },\n\n    /**\n     * Returns a job status icon class.\n     * @param {number} status\n     * @returns {string}\n     */\n    jobStatusIconClass(status) {\n      let c = 'status';\n      switch (status) {\n        case 1:\n          c += ' orange';\n          break;\n        case 2:\n          c += ' green';\n          break;\n        case 4:\n          c += ' red';\n          break;\n      }\n      return c;\n    },\n\n    /**\n     * Returns a job attribute name.\n     * @param {string} name\n     * @returns {string}\n     */\n    jobAttributeName(name) {\n      switch (name) {\n        case 'id':\n          return Craft.t('app', 'ID');\n        case 'status':\n          return Craft.t('app', 'Status');\n        case 'progress':\n          return Craft.t('app', 'Progress');\n        case 'description':\n          return Craft.t('app', 'Description');\n        case 'ttr':\n          return Craft.t('app', 'Time to reserve');\n        case 'error':\n          return Craft.t('app', 'Error');\n        default:\n          return name;\n      }\n    },\n\n    /**\n     * Formats a TTR value.\n     * @param {string} value\n     * @return {string}\n     */\n    ttrValue(value) {\n      return Craft.t(\n        'app',\n        '{num, number} {num, plural, =1{second} other{seconds}}',\n        {\n          num: value,\n        }\n      );\n    },\n  },\n});\n"],"names":["Vue","el","delimiters","data","loading","indexTimeout","jobs","totalJobs","totalJobsFormatted","activeJobId","activeJob","limit","mounted","_this","document","getElementById","removeAttribute","Craft","cp","on","jobInfo","slice","formatNumber","refreshActiveJob","window","onpopstate","event","state","jobId","setActiveJob","clearActiveJob","m","path","match","history","replaceState","this","url","methods","updateJobProgress","trackJobProgress","pushState","_this2","Promise","resolve","reject","clearTimeout","axios","get","getActionUrl","then","response","id","e","_e$response","displayError","message","_this3","oldJob","success","status","$","extend","progress","error","progressLabel","catch","retryAll","_this4","sendActionRequest","displayNotice","t","releaseAll","_this5","confirm","retryJob","job","_this6","description","retryActiveJob","_this7","releaseJob","_this8","_ref","releaseActiveJob","_this9","released","getUrl","isRetryable","jobStatusClass","jobStatusLabel","delay","jobStatusIconClass","c","jobAttributeName","name","ttrValue","value","num"],"sourceRoot":""}