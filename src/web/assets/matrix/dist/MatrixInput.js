!function(t){Craft.MatrixInput=Garnish.Base.extend({id:null,entryTypes:null,entryTypesByHandle:null,inputNamePrefix:null,inputIdPrefix:null,showingAddEntryMenu:!1,addEntryBtnGroupWidth:null,addEntryBtnContainerWidth:null,$container:null,$form:null,$entriesContainer:null,$addEntryBtnContainer:null,$addEntryBtnGroup:null,$addEntryBtnGroupBtns:null,$addEntryMenuBtn:null,$statusMessage:null,entrySort:null,entrySelect:null,totalNewEntries:0,init:function(n,a,i,r){var s=this;this.id=n,this.entryTypes=a,this.inputNamePrefix=i,this.inputIdPrefix=Craft.formatInputId(this.inputNamePrefix),"number"==typeof r&&(r={maxEntries:r}),this.setSettings(r,Craft.MatrixInput.defaults),this.$container=t("#"+this.id),this.$form=this.$container.closest("form"),this.$entriesContainer=this.$container.children(".blocks"),this.$addEntryBtnContainer=this.$container.children(".buttons"),this.$addEntryBtnGroup=this.$addEntryBtnContainer.children(".btngroup"),this.$addEntryBtnGroupBtns=this.$addEntryBtnGroup.children(".btn"),this.$addEntryMenuBtn=this.$addEntryBtnContainer.children(".menubtn"),this.$statusMessage=this.$container.find("[data-status-message]"),this.$container.data("matrix",this),this.setNewEntryBtn(),this.entryTypesByHandle={};for(var d=0;d<this.entryTypes.length;d++){var o=this.entryTypes[d];this.entryTypesByHandle[o.handle]=o}var l=this.$entriesContainer.children(),c=Craft.MatrixInput.getCollapsedEntryIds();this.entrySort=new Garnish.DragSort(l,{handle:"> .actions > .move",axis:"y",filter:function(){return s.entrySort.$targetItem.hasClass("sel")?s.entrySelect.getSelectedItems():s.entrySort.$targetItem},collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,helperOpacity:.9,onDragStop:function(){s.trigger("entrySortDragStop")},onSortChange:function(){s.entrySelect.resetItemOrder()}}),this.entrySelect=new Garnish.Select(this.$entriesContainer,l,{multi:!0,vertical:!0,handle:"> .checkbox, > .titlebar",checkboxMode:!0});for(var h=0;h<l.length;h++){var p=t(l[h]),u=p.data("id"),f="string"==typeof u&&u.match(/new(\d+)/);f&&f[1]>this.totalNewEntries&&(this.totalNewEntries=parseInt(f[1]));var y=new e(this,p);y.id&&-1!==t.inArray(""+y.id,c)&&y.collapse()}this.addListener(this.$addEntryBtnGroupBtns,"click",(function(e){var n=t(e.target).data("type");this.addEntry(n)})),this.$addEntryMenuBtn.length&&(this.$addEntryMenuBtn.menubtn(),this.$addEntryMenuBtn.data("menubtn").on("optionSelect",(function(e){s.addEntry(t(e.option).data("type"))}))),this.updateAddEntryBtn(),this.addListener(this.$container,"resize","setNewEntryBtn"),Garnish.$doc.ready(this.setNewEntryBtn.bind(this)),this.trigger("afterInit")},setNewEntryBtn:function(){var t=this;(this.addEntryBtnGroupWidth||(this.addEntryBtnGroupWidth=this.$addEntryBtnGroup.width(),this.addEntryBtnGroupWidth))&&this.addEntryBtnContainerWidth!==(this.addEntryBtnContainerWidth=this.$addEntryBtnContainer.width())&&(this.addEntryBtnGroupWidth>this.addEntryBtnContainerWidth?this.showingAddEntryMenu||(this.$addEntryBtnGroup.addClass("hidden"),this.$addEntryMenuBtn.removeClass("hidden"),this.showingAddEntryMenu=!0):this.showingAddEntryMenu&&(this.$addEntryMenuBtn.addClass("hidden"),this.$addEntryBtnGroup.removeClass("hidden"),this.showingAddEntryMenu=!1,-1!==navigator.userAgent.indexOf("Safari")&&Garnish.requestAnimationFrame((function(){t.$addEntryBtnGroup.css("opacity",.99),Garnish.requestAnimationFrame((function(){t.$addEntryBtnGroup.css("opacity","")}))}))))},canAddMoreEntries:function(){return!this.maxEntries||this.$entriesContainer.children().length<this.maxEntries},updateAddEntryBtn:function(){if(this.canAddMoreEntries()){this.$addEntryBtnGroup.removeClass("disabled"),this.$addEntryMenuBtn.removeClass("disabled"),this.$addEntryBtnGroupBtns.each((function(){t(this).removeAttr("aria-disabled")}));for(var e=0;e<this.entrySelect.$items.length;e++){var n=this.entrySelect.$items.eq(e).data("entry");n&&(n.$actionMenu.find("a[data-action=add]").parent().removeClass("disabled"),n.$actionMenu.find("a[data-action=add]").removeAttr("aria-disabled"))}}else{this.$addEntryBtnGroup.addClass("disabled"),this.$addEntryMenuBtn.addClass("disabled"),this.$addEntryBtnGroupBtns.each((function(){t(this).attr("aria-disabled","true")}));for(var a=0;a<this.entrySelect.$items.length;a++){var i=this.entrySelect.$items.eq(a).data("entry");i&&(i.$actionMenu.find("a[data-action=add]").parent().addClass("disabled"),i.$actionMenu.find("a[data-action=add]").attr("aria-disabled","true"))}}},updateStatusMessage:function(){var t,e=this;this.$statusMessage.empty(),this.canAddMoreEntries()||(t=Craft.t("app","Entry could not be added. Maximum number of entries reached.")),setTimeout((function(){e.$statusMessage.text(t)}),250)},addEntry:function(n,a,i){var r=this;if(this.canAddMoreEntries()){this.totalNewEntries++;var s="new".concat(this.totalNewEntries),d=this.entryTypesByHandle[n].name,o="matrixblock-action-menu-".concat(s),l='\n                <div class="matrixblock" data-id="'.concat(s,'" data-type="').concat(n,'" data-type-name="').concat(d,'" role="listitem">\n                  <input type="hidden" name="').concat(this.inputNamePrefix,'[sortOrder][]" value="').concat(s,'"/>\n                  <input type="hidden" name="').concat(this.inputNamePrefix,"[entries][").concat(s,'][type]" value="').concat(n,'"/>\n                  <input type="hidden" name="').concat(this.inputNamePrefix,"[entries][").concat(s,'][enabled]" value="1"/>\n                  <div class="titlebar">\n                    <div class="entrytype">').concat(this.getEntryTypeByHandle(n).name,'</div>\n                    <div class="preview"></div>\n                  </div>\n                  <div class="checkbox" title="').concat(Craft.t("app","Select"),'"></div>\n                  <div class="actions">\n                    <div class="status off" title="').concat(Craft.t("app","Disabled"),'"></div>\n                    <div>\n                      <button type="button" class="btn settings icon menubtn" title="').concat(Craft.t("app","Actions"),'" aria-controls="').concat(o,'" data-disclosure-trigger></button>\n                        <div id="').concat(o,'" class="menu menu--disclosure">\n                         <ul class="padded">\n                            <li><a data-icon="collapse" data-action="collapse" href="#" aria-label="').concat(Craft.t("app","Collapse"),'" type="button" role="button">').concat(Craft.t("app","Collapse"),'</a></li>\n                            <li class="hidden"><a data-icon="expand" data-action="expand" href="#" aria-label="').concat(Craft.t("app","Expand"),'" type="button" role="button">').concat(Craft.t("app","Expand"),'</a></li>\n                            <li><a data-icon="disabled" data-action="disable" href="#" aria-label="').concat(Craft.t("app","Disable"),'" type="button" role="button">').concat(Craft.t("app","Disable"),'</a></li>\n                            <li class="hidden"><a data-icon="enabled" data-action="enable" href="#" aria-label="').concat(Craft.t("app","Enable"),'" type="button" role="button">').concat(Craft.t("app","Enable"),'</a></li>\n                            <li><a data-icon="uarr" data-action="moveUp" href="#" aria-label="').concat(Craft.t("app","Move up"),'" type="button" role="button">').concat(Craft.t("app","Move up"),'</a></li>\n                            <li><a data-icon="darr" data-action="moveDown" href="#" aria-label="').concat(Craft.t("app","Move down"),'" type="button" role="button">').concat(Craft.t("app","Move down"),"</a></li>\n                          </ul>");if(!this.settings.staticEntries){l+='\n                          <hr class="padded"/>\n                          <ul class="padded">\n                            <li><a class="error" data-icon="remove" data-action="delete" href="#" aria-label="'.concat(Craft.t("app","Delete"),'" type="button" role="button">').concat(Craft.t("app","Delete"),'</a></li>\n                          </ul>\n                          <hr class="padded"/>\n                          <ul class="padded">');for(var c=0;c<this.entryTypes.length;c++){var h=this.entryTypes[c];l+='\n                            <li><a data-icon="plus" data-action="add" data-type="'.concat(h.handle,'" href="#" aria-label="').concat(Craft.t("app","Add {type} above",{type:h.name}),'" type="button" role="button">').concat(Craft.t("app","Add {type} above",{type:h.name}),"</a></li>")}l+="\n                          </ul>"}l+='\n                        </div>\n                      </div>\n                    <a class="move icon" title="'.concat(Craft.t("app","Reorder"),'" role="button"></a>\n                  </div>\n                </div>');var p=t(l),u=this.$form.data("elementEditor");u&&u.pause(),a?p.insertBefore(a):p.appendTo(this.$entriesContainer);var f=t('<div class="fields"/>').appendTo(p),y=this.getParsedEntryHtml(this.entryTypesByHandle[n].bodyHtml,s),m=this.getParsedEntryHtml(this.entryTypesByHandle[n].js,s);t(y).appendTo(f),this.trigger("entryAdded",{$entry:p}),p.css(this.getHiddenEntryCss(p)).velocity({opacity:1,"margin-bottom":10},"fast",(function(){p.css("margin-bottom",""),Garnish.$bod.append(m),Craft.initUiElements(f),new e(r,p),r.entrySort.addItems(p),r.entrySelect.addItems(p),r.updateAddEntryBtn(),Garnish.requestAnimationFrame((function(){(void 0===i||i)&&(Garnish.scrollContainerToElement(p),p.find(".flex-fields :focusable").first().trigger("focus")),u&&u.resume()}))}))}else this.updateStatusMessage()},getEntryTypeByHandle:function(t){for(var e=0;e<this.entryTypes.length;e++)if(this.entryTypes[e].handle===t)return this.entryTypes[e]},collapseSelectedEntries:function(){this.callOnSelectedEntries("collapse")},expandSelectedEntries:function(){this.callOnSelectedEntries("expand")},disableSelectedEntries:function(){this.callOnSelectedEntries("disable")},enableSelectedEntries:function(){this.callOnSelectedEntries("enable")},deleteSelectedEntries:function(){this.callOnSelectedEntries("selfDestruct")},callOnSelectedEntries:function(t){for(var e=0;e<this.entrySelect.$selectedItems.length;e++)this.entrySelect.$selectedItems.eq(e).data("entry")[t]()},getHiddenEntryCss:function(t){return{opacity:0,marginBottom:-t.outerHeight()}},getParsedEntryHtml:function(t,e){return"string"==typeof t?t.replace(new RegExp("__ENTRY_".concat(this.settings.placeholderKey,"__"),"g"),e):""},get maxEntries(){return this.settings.maxEntries}},{defaults:{placeholderKey:null,maxEntries:null,staticEntries:!1},collapsedEntryStorageKey:"Craft-"+Craft.systemUid+".MatrixInput.collapsedEntries",getCollapsedEntryIds:function(){return"string"==typeof localStorage[Craft.MatrixInput.collapsedEntryStorageKey]?Craft.filterArray(localStorage[Craft.MatrixInput.collapsedEntryStorageKey].split(",")):[]},setCollapsedEntryIds:function(t){localStorage[Craft.MatrixInput.collapsedEntryStorageKey]=t.join(",")},rememberCollapsedEntryId:function(e){if("undefined"!=typeof Storage){var n=Craft.MatrixInput.getCollapsedEntryIds();-1===t.inArray(""+e,n)&&(n.push(e),Craft.MatrixInput.setCollapsedEntryIds(n))}},forgetCollapsedEntryId:function(e){if("undefined"!=typeof Storage){var n=Craft.MatrixInput.getCollapsedEntryIds(),a=t.inArray(""+e,n);-1!==a&&(n.splice(a,1),Craft.MatrixInput.setCollapsedEntryIds(n))}}});var e=Garnish.Base.extend({matrix:null,$container:null,$titlebar:null,$fieldsContainer:null,$previewContainer:null,$actionMenu:null,$collapsedInput:null,actionDisclosure:null,isNew:null,id:null,collapsed:!1,init:function(t,e){var n=this;this.matrix=t,this.$container=e,this.$titlebar=e.children(".titlebar"),this.$previewContainer=this.$titlebar.children(".preview"),this.$fieldsContainer=e.children(".fields"),this.$container.data("entry",this),this.id=this.$container.data("id"),this.isNew=!this.id||"string"==typeof this.id&&"new"===this.id.substring(0,3);var a=this.$container.find("> .actions [data-disclosure-trigger]"),i=a.data("trigger")||new Garnish.DisclosureMenu(a);this.$actionMenu=i.$container,this.actionDisclosure=i,i.on("show",(function(){n.$container.addClass("active"),n.$container.prev(".matrixblock").length?n.$actionMenu.find("a[data-action=moveUp]:first").parent().removeClass("hidden"):n.$actionMenu.find("a[data-action=moveUp]:first").parent().addClass("hidden"),n.$container.next(".matrixblock").length?n.$actionMenu.find("a[data-action=moveDown]:first").parent().removeClass("hidden"):n.$actionMenu.find("a[data-action=moveDown]:first").parent().addClass("hidden")})),i.on("hide",(function(){n.$container.removeClass("active")})),this.$actionMenuOptions=this.$actionMenu.find("a[data-action]"),this.addListener(this.$actionMenuOptions,"click",this.handleActionClick),this.addListener(this.$actionMenuOptions,"keydown",this.handleActionKeydown),Garnish.hasAttr(this.$container,"data-collapsed")&&this.collapse(),this._handleTitleBarClick=function(t){t.preventDefault(),this.toggle()},this.addListener(this.$titlebar,"doubletap",this._handleTitleBarClick)},toggle:function(){this.collapsed?this.expand():this.collapse(!0)},collapse:function(e){var n=this;if(!this.collapsed){this.$container.addClass("collapsed");for(var a="",i=this.$fieldsContainer.children().children(),r=0;r<i.length;r++){for(var s=t(i[r]).children(".input").find('select,input[type!="hidden"],textarea,.label'),d="",o=0;o<s.length;o++){var l=t(s[o]),c=void 0;if(l.hasClass("label")){var h=l.parent().parent();if(h.hasClass("lightswitch")&&(h.hasClass("on")&&l.hasClass("off")||!h.hasClass("on")&&l.hasClass("on")))continue;c=l.text()}else c=Craft.getText(this._inputPreviewText(l));c instanceof Array&&(c=c.join(", ")),c&&(c=Craft.trim(Craft.escapeHtml(c)))&&(d&&(d+=", "),d+=c)}d&&(a+=(a?" <span>|</span> ":"")+d)}this.$previewContainer.html(a),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop"),e&&!Garnish.prefersReducedMotion()?(this.$fieldsContainer.velocity("fadeOut",{duration:"fast"}),this.$container.velocity({height:32},"fast")):(this.$previewContainer.show(),this.$fieldsContainer.hide(),this.$container.css({height:32})),setTimeout((function(){n.$actionMenu.find("a[data-action=collapse]:first").parent().addClass("hidden"),n.$actionMenu.find("a[data-action=expand]:first").parent().removeClass("hidden")}),200),this.isNew?this.$collapsedInput?this.$collapsedInput.val("1"):this.$collapsedInput=t('<input type="hidden" name="'+this.matrix.inputNamePrefix+"[entries]["+this.id+'][collapsed]" value="1"/>').appendTo(this.$container):Craft.MatrixInput.rememberCollapsedEntryId(this.id),this.collapsed=!0}},_inputPreviewText:function(e){if(e.is("select,multiselect")){for(var n=[],a=e.find("option:selected"),i=0;i<a.length;i++)n.push(a.eq(i).text());return n}if(e.is('input[type="checkbox"]:checked,input[type="radio"]:checked')){var r=e.attr("id"),s=t('label[for="'.concat(r,'"]'));if(s.length)return s.text()}return Garnish.getInputPostVal(e)},expand:function(){var e=this;if(this.collapsed){this.$container.removeClass("collapsed"),this.$fieldsContainer.velocity("stop"),this.$container.velocity("stop");var n=this.$container.height();this.$container.height("auto"),this.$fieldsContainer.show();var a=this.$container.height(),i=this.$fieldsContainer.css("display")||"block";this.$container.height(n),this.$fieldsContainer.hide().velocity("fadeIn",{duration:"fast",display:i});var r=Garnish.prefersReducedMotion()?0:"fast";if(this.$container.velocity({height:a},r,(function(){e.$previewContainer.html(""),e.$container.height("auto"),e.$container.trigger("scroll")})),setTimeout((function(){e.$actionMenu.find("a[data-action=collapse]:first").parent().removeClass("hidden"),e.$actionMenu.find("a[data-action=expand]:first").parent().addClass("hidden")}),200),!this.isNew&&"undefined"!=typeof Storage){var s=Craft.MatrixInput.getCollapsedEntryIds(),d=t.inArray(""+this.id,s);-1!==d&&(s.splice(d,1),Craft.MatrixInput.setCollapsedEntryIds(s))}this.isNew?this.$collapsedInput&&this.$collapsedInput.val(""):Craft.MatrixInput.forgetCollapsedEntryId(this.id),this.collapsed=!1}},disable:function(){var t=this;this.$container.children('input[name$="[enabled]"]:first').val(""),this.$container.addClass("disabled"),setTimeout((function(){t.$actionMenu.find("a[data-action=disable]:first").parent().addClass("hidden"),t.$actionMenu.find("a[data-action=enable]:first").parent().removeClass("hidden")}),200),this.collapse(!0)},enable:function(){var t=this;this.$container.children('input[name$="[enabled]"]:first').val("1"),this.$container.removeClass("disabled"),setTimeout((function(){t.$actionMenu.find("a[data-action=disable]:first").parent().removeClass("hidden"),t.$actionMenu.find("a[data-action=enable]:first").parent().addClass("hidden")}),200)},moveUp:function(){this.matrix.trigger("beforeMoveEntryUp",{entry:this});var t=this.$container.prev(".matrixblock");t.length&&(this.$container.insertBefore(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryUp",{entry:this})},moveDown:function(){this.matrix.trigger("beforeMoveEntryDown",{entry:this});var t=this.$container.next(".matrixblock");t.length&&(this.$container.insertAfter(t),this.matrix.entrySelect.resetItemOrder()),this.matrix.trigger("moveEntryDown",{entry:this})},handleActionClick:function(t){t.preventDefault(),this.onActionSelect(t.target)},handleActionKeydown:function(t){t.keyCode===Garnish.SPACE_KEY&&(t.preventDefault(),this.onActionSelect(t.target))},onActionSelect:function(e){var n=this.matrix.entrySelect.totalSelected>1&&this.matrix.entrySelect.isSelected(this.$container),a=t(e);switch(a.data("action")){case"collapse":n?this.matrix.collapseSelectedEntries():this.collapse(!0);break;case"expand":n?this.matrix.expandSelectedEntries():this.expand();break;case"disable":n?this.matrix.disableSelectedEntries():this.disable();break;case"enable":n?this.matrix.enableSelectedEntries():(this.enable(),this.expand());break;case"moveUp":this.moveUp();break;case"moveDown":this.moveDown();break;case"add":var i=a.data("type");this.matrix.addEntry(i,this.$container);break;case"delete":n?confirm(Craft.t("app","Are you sure you want to delete the selected entries?"))&&this.matrix.deleteSelectedEntries():this.selfDestruct()}this.actionDisclosure.hide()},selfDestruct:function(){var e=this;t("[name]",this.$container).removeAttr("name"),this.$container.velocity(this.matrix.getHiddenEntryCss(this.$container),"fast",(function(){e.$container.remove(),e.matrix.updateAddEntryBtn(),e.matrix.trigger("entryDeleted",{$entry:e.$container})}))}})}(jQuery);
//# sourceMappingURL=MatrixInput.js.map