!function(){"use strict";function t(t){const e=new Uint8Array(t);let n="";for(const t of e)n+=String.fromCharCode(t);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function e(t){const e=t.replace(/-/g,"+").replace(/_/g,"/"),n=(4-e.length%4)%4,r=e.padEnd(e.length+n,"="),a=atob(r),i=new ArrayBuffer(a.length),o=new Uint8Array(i);for(let t=0;t<a.length;t++)o[t]=a.charCodeAt(t);return i}function n(){return void 0!==(null===window||void 0===window?void 0:window.PublicKeyCredential)&&"function"==typeof window.PublicKeyCredential}function r(t){const{id:n}=t;return{...t,id:e(n),transports:t.transports}}class a extends Error{constructor(t,e="WebAuthnError"){super(t),this.name=e}}const i=new class{createNewAbortSignal(){this.controller&&this.controller.abort("Cancelling existing WebAuthn API call for new one");const t=new AbortController;return this.controller=t,t.signal}},o=["cross-platform","platform"];function s(t){if(t&&!(o.indexOf(t)<0))return t}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var u;u=jQuery,Craft.Mfa=Garnish.Base.extend({$mfaLoginFormContainer:null,$mfaSetupFormContainer:null,$alternativeMfaLink:null,$alternativeMfaTypesContainer:null,$viewSetupBtns:null,$errors:null,$slideout:null,$removeSetupButton:null,$closeButton:null,$verifyButton:null,init:function(t){this.$mfaLoginFormContainer=u("#mfa-form"),this.$mfaSetupFormContainer=u("#mfa-setup"),this.$alternativeMfaLink=u("#alternative-mfa"),this.$alternativeMfaTypesContainer=u("#alternative-mfa-types"),this.$viewSetupBtns=this.$mfaSetupFormContainer.find("button.mfa-view-setup"),this.setSettings(t,Craft.Mfa.defaults),this.addListener(this.$alternativeMfaLink,"click","onAlternativeMfaTypeClick"),this.addListener(this.$viewSetupBtns,"click","onViewSetupBtnClick")},showMfaForm:function(t,e){this.$mfaLoginFormContainer.html("").append(t),e.addClass("mfa"),u("#login-form-buttons").hide();var n=this.$mfaLoginFormContainer.find(".submit");this.$errors=u("#login-errors"),this.onSubmitResponse(n)},getCurrentMfaType:function(t){var e=t.attr("data-mfa-type");return void 0===e&&(e=null),e},submitMfaCode:function(){var t=this,e=this.$mfaLoginFormContainer.find(".submit");e.addClass("loading");var n={mfaFields:{},currentMethod:null};n.mfaFields=this._getMfaFields(this.$mfaLoginFormContainer),n.currentMethod=this._getCurrentMethodInput(this.$mfaLoginFormContainer),Craft.sendActionRequest("POST","users/verify-mfa",{data:n}).then((function(t){window.location.href=t.data.returnUrl})).catch((function(n){var r=n.response;t.onSubmitResponse(e),t.showError(r.data.message)}))},onViewSetupBtnClick:function(t){var e=this,r=u(t.currentTarget);r.disable(),t.preventDefault();var a={selectedMethod:this.getCurrentMfaType(r)};Craft.sendActionRequest("POST",this.settings.setupSlideoutHtml,{data:a}).then((function(t){e.slideout=new Craft.Slideout(t.data.html),e.$errors=e.slideout.$container.find(".so-notice"),e.$closeButton=e.slideout.$container.find("button.close"),"craft\\mfa\\type\\WebAuthn"===a.selectedMethod&&n()&&new Craft.WebAuthnSetup(e.slideout),e.$verifyButton=e.slideout.$container.find("#mfa-verify"),e.$removeSetupButton=e.slideout.$container.find("#mfa-remove-setup"),e.addListener(e.$removeSetupButton,"click","onRemoveSetup"),e.addListener(e.$closeButton,"click","onClickClose"),e.addListener(e.$verifyButton,"click","onVerify"),e.slideout.on("close",(function(t){e.$removeSetupButton=null,e.slideout=null,r.enable()}))})).catch((function(t){var e=t.response;Craft.cp.displayError(e.data.message),r.enable()}))},onClickClose:function(t){this.slideout.close()},onRemoveSetup:function(t){var e=this;t.preventDefault();var n=this.getCurrentMfaType(this.slideout.$container.find("#mfa-setup-form"));void 0===n&&(n=null);var r={currentMethod:n};confirm(Craft.t("app","Are you sure you want to delete this setup?"))&&Craft.sendActionRequest("POST",this.settings.removeSetup,{data:r}).then((function(e){u(t.currentTarget).remove(),Craft.cp.displayNotice(Craft.t("app","MFA setup removed."))})).catch((function(t){Craft.cp.displayError(t.response.data.message)})).finally((function(){e.slideout.close()}))},onVerify:function(t){var e=this;t.preventDefault();var n=this.slideout.$container.find("#mfa-verify");n.addClass("loading");var r={mfaFields:{},currentMethod:null};r.mfaFields=this._getMfaFields(this.slideout.$container),r.currentMethod=this._getCurrentMethodInput(this.slideout.$container),Craft.sendActionRequest("POST",this.settings.saveSetup,{data:r}).then((function(t){e.onSubmitResponse(n),Craft.cp.displayNotice(Craft.t("app","MFA settings saved.")),e.slideout.close()})).catch((function(t){var r=t.response;e.onSubmitResponse(n),e.showError(r.data.message),Craft.cp.displayError(r.data.message)}))},onSubmitResponse:function(t){t.removeClass("loading")},showError:function(t){this.clearErrors(),u('<p class="error" style="display: none;">'+t+"</p>").appendTo(this.$errors).velocity("fadeIn")},clearErrors:function(){this.$errors.empty()},onAlternativeMfaTypeClick:function(t){var e=this.getCurrentMfaType(this.$mfaLoginFormContainer.find("#verifyContainer"));null===e&&(this.$alternativeMfaLink.hide(),this.showError(Craft.t("app","No alternative MFA methods available.")));var n={currentMethod:e};this.getAlternativeMfaTypes(n)},getAlternativeMfaTypes:function(t){var e=this;Craft.sendActionRequest("POST",this.settings.fetchAlternativeMfaTypes,{data:t}).then((function(t){void 0!==t.data.alternativeTypes&&e.showAlternativeMfaTypes(t.data.alternativeTypes)})).catch((function(t){var n=t.response;e.showError(n.data.message)}))},showAlternativeMfaTypes:function(t){var e=this,n=Object.entries(t).map((function(t){var e,n,r=(n=2,function(t){if(Array.isArray(t))return t}(e=t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,a,i=[],o=!0,s=!1;try{for(n=n.call(t);!(o=(r=n.next()).done)&&(i.push(r.value),!e||i.length!==e);o=!0);}catch(t){s=!0,a=t}finally{try{o||null==n.return||n.return()}finally{if(s)throw a}}return i}}(e,n)||function(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());return{key:r[0],value:r[1]}}));n.length>0&&n.forEach((function(t){e.$alternativeMfaTypesContainer.append('<li><button class="alternative-mfa-type" type="button" value="'+t.key+'">'+t.value.name+"</button></li>")})),this.$alternativeMfaLink.hide().after(this.$alternativeMfaTypesContainer),this.addListener(u(".alternative-mfa-type"),"click","onSelectAlternativeMfaType")},onSelectAlternativeMfaType:function(t){var e=this,n={selectedMethod:u(t.currentTarget).attr("value")};Craft.sendActionRequest("POST",this.settings.loadAlternativeMfaType,{data:n}).then((function(t){void 0!==t.data.mfaForm&&(e.$mfaLoginFormContainer.html("").append(t.data.mfaForm),e.$alternativeMfaTypesContainer.html(""),e.$alternativeMfaLink.show(),e.onSubmitResponse())})).catch((function(t){t.response}))},_getMfaFields:function(t){var e={};return t.find('input[name^="mfaFields[').each((function(t,n){var r=u(n).attr("id");e[r]=u(n).val()})),e},_getCurrentMethodInput:function(t){return t.find('input[name="currentMethod"').val()}},{defaults:{fetchAlternativeMfaTypes:"mfa/fetch-alternative-mfa-types",loadAlternativeMfaType:"mfa/load-alternative-mfa-type",setupSlideoutHtml:"mfa/setup-slideout-html",saveSetup:"mfa/save-setup",removeSetup:"mfa/remove-setup"}}),function(o){Craft.WebAuthnSetup=Garnish.Base.extend({$addSecurityKeyBtn:null,$noticeContainer:null,$keysTable:null,slideout:null,init:function(t,e){console.log("init"),this.slideout=t,this.setSettings(e,Craft.WebAuthnSetup.defaults),this.$addSecurityKeyBtn=o("#add-security-key"),this.$noticeContainer=this.slideout.$container.find(".so-notice"),this.$keysTable=this.slideout.$container.find("#webauthn-security-keys"),n()||(Craft.cp.displayError(Craft.t("app","This browser does not support WebAuth.")),this.$addSecurityKeyBtn.disable()),this.addListener(this.$addSecurityKeyBtn,"click","onAddSecurityKeyBtn"),null!==this.$keysTable&&this.addListener(this.$keysTable.find(".delete"),"click","onDeleteSecurityKey")},onAddSecurityKeyBtn:function(t){o(t.currentTarget).hasClass("disabled")||(this.showStatus(Craft.t("app","Waiting for elevated session")),Craft.elevatedSessionManager.requireElevatedSession(this.startWebAuthRegistration.bind(this),this.failedElevation.bind(this)))},failedElevation:function(){this.clearStatus()},startWebAuthRegistration:function(){var o=this;this.clearStatus(),Craft.sendActionRequest("POST",this.settings.generateRegistrationOptions).then((function(l){var u=l.data.registrationOptions;try{o.showStatus(Craft.t("app","Starting registration"));var c=Craft.escapeHtml(prompt(Craft.t("app","Please enter a name for the security key")));(async function(o){var l,u;if(!n())throw new Error("WebAuthn is not supported in this browser");const c={publicKey:{...o,challenge:e(o.challenge),user:{...o.user,id:(u=o.user.id,(new TextEncoder).encode(u))},excludeCredentials:null===(l=o.excludeCredentials)||void 0===l?void 0:l.map(r)}};let d;c.signal=i.createNewAbortSignal();try{d=await navigator.credentials.create(c)}catch(t){throw function({error:t,options:e}){var n,r;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if("AbortError"===t.name){if(e.signal===(new AbortController).signal)return new a("Registration ceremony was sent an abort signal","AbortError")}else if("ConstraintError"===t.name){if(!0===(null===(n=i.authenticatorSelection)||void 0===n?void 0:n.requireResidentKey))return new a("Discoverable credentials were required but no available authenticator supported it","ConstraintError");if("required"===(null===(r=i.authenticatorSelection)||void 0===r?void 0:r.userVerification))return new a("User verification was required but no available authenticator supported it","ConstraintError")}else{if("InvalidStateError"===t.name)return new a("The authenticator was previously registered","InvalidStateError");if("NotAllowedError"===t.name);else{if("NotSupportedError"===t.name)return 0===i.pubKeyCredParams.filter((t=>"public-key"===t.type)).length?new a('No entry in pubKeyCredParams was of type "public-key"',"NotSupportedError"):new a("No available authenticator supported any of the specified pubKeyCredParams algorithms","NotSupportedError");if("SecurityError"===t.name){const t=window.location.hostname;if("localhost"!==(o=t)&&!/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(o))return new a(`${window.location.hostname} is an invalid domain`,"SecurityError");if(i.rp.id!==t)return new a(`The RP ID "${i.rp.id}" is invalid for this domain`,"SecurityError")}else if("TypeError"===t.name){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new a("User ID was not between 1 and 64 characters","TypeError")}else if("UnknownError"===t.name)return new a("The authenticator was unable to process the specified options, or could not create a new credential","UnknownError")}}var o;return t}({error:t,options:c})}if(!d)throw new Error("Registration was not completed");const{id:f,rawId:h,response:p,type:m}=d;let v;return"function"==typeof p.getTransports&&(v=p.getTransports()),{id:f,rawId:t(h),response:{attestationObject:t(p.attestationObject),clientDataJSON:t(p.clientDataJSON),transports:v},type:m,clientExtensionResults:d.getClientExtensionResults(),authenticatorAttachment:s(d.authenticatorAttachment)}})(u).then((function(t){o.verifyWebAuthnRegistration(t,c)})).catch((function(t){o.showStatus(Craft.t("app","Registration failed:")+" "+t.message,"error")}))}catch(t){o.showStatus(t,"error")}})).catch((function(t){var e=t.response;o.showStatus(e.data.message,"error")}))},verifyWebAuthnRegistration:function(t,e){var n=this;this.showStatus(Craft.t("app","Starting verification"));var r={credentials:JSON.stringify(t),credentialName:e};Craft.sendActionRequest("POST",this.settings.verifyRegistration,{data:r}).then((function(t){n.clearStatus(),t.data.verified?(Craft.cp.displaySuccess(Craft.t("app","Security key registered.")),t.data.html&&(n.slideout.$container.html(t.data.html),n.init(n.slideout))):n.showStatus("Something went wrong!","error")})).catch((function(t){var e=t.response;n.showStatus(e.data.message,"error")}))},onDeleteSecurityKey:function(t){var e=this;t.preventDefault();var n=o(t.currentTarget).attr("data-uid"),r=o(t.currentTarget).parents("tr").find('[data-name="credentialName"]').text(),a={uid:n},i=confirm(Craft.t("app","Are you sure you want to delete ‘{credentialName}‘ security key?",{credentialName:r}));void 0!==n&&i&&Craft.sendActionRequest("POST",this.settings.deleteSecurityKey,{data:a}).then((function(t){Craft.cp.displaySuccess(t.data.message),t.data.html&&(e.slideout.$container.html(t.data.html),e.init(e.slideout))})).catch((function(t){var n=t.response;e.showStatus(n.data.message,"error")}))},showStatus:function(t,e){"error"==e?this.$noticeContainer.addClass("error"):this.$noticeContainer.removeClass("error"),this.$noticeContainer.text(t)},clearStatus:function(){this.$noticeContainer.text("")}},{defaults:{generateRegistrationOptions:"mfa/generate-registration-options",verifyRegistration:"mfa/verify-registration",deleteSecurityKey:"mfa/delete-security-key"}})}(jQuery)}();
//# sourceMappingURL=mfa.js.map