{% do view.registerJs('new Craft.Auth2fa') %}

{% import '_includes/forms.twig' as forms %}

{{ forms.checkboxField({
    label: 'Enable 2FA'|t('app'),
    name: 'has2fa',
    id: 'has2fa',
    instructions: 'Should Two-Factor Authentication (2FA) be enabled for this user.'|t('app'),
    checked: user ? user.is2faRequired() : false,
    toggle: (user.id == currentUser.id) ? 'auth-2fa-setup' : false,
    disabled: user.canTurnOff2fa() == false
}) }}

{% if user.id == currentUser.id %}
    {% do view.registerDeltaName('auth-2fa-setup') %}


    <div id="auth-2fa-setup">
        {% set auth2faTypes = craft.app.auth.getAll2faTypes(true) %}
        {% if auth2faTypes is empty %}
            <p class="zilch">{{ 'No 2FA options available.'|t('app') }}</p>
        {% else %}
            {% for key, option in auth2faTypes %}
                {% set isSetup = option.config.requiresSetup == false or (option.config.requiresSetup and user.is2faTypeSetup(key)) %}

                <div class="auth-2fa-type">
                    <strong>{{ option.name }}</strong>
                    <div class="instructions">
                        {{ option.description }}
                    </div>

                    {% if option.config.requiresSetup %}
                        {{ forms.button({
                            class: 'auth-2fa-view-setup',
                            label: 'View setup'|t('app'),
                            spinner: craft.app.request.isCpRequest(),
                            type: 'button',
                            attributes: {
                                'data-2fa-type': key
                            }
                        }) }}
                    {% endif %}
                </div>
                {% if loop.last == false %}
                    <hr />
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endif %}